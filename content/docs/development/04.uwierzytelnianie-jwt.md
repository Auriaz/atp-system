---
title: 'Uwierzytelnianie JWT'
description: 'Kompleksowy system uwierzytelniania JWT z automatycznym wylogowaniem w systemie ATP'
category: 'Development'
version: '2.0.0'
requiredRole: ['admin', 'manager']
icon: 'i-heroicons-key'
createdAt: '2025-05-26'
lastUpdated: '2025-05-28'
status: 'published'
difficulty: 'advanced'
readingTime: 20
docType: 'guide'
---

# Uwierzytelnianie JWT z automatycznym wylogowaniem

::alert{type="success"}
System uwierzytelniania JWT z automatycznym wylogowaniem zostaÅ‚ **w peÅ‚ni zaimplementowany i przetestowany**. Wszystkie komponenty sÄ… gotowe do produkcji.
::

## ğŸ” PrzeglÄ…d systemu

ATP System wykorzystuje zaawansowany system uwierzytelniania oparty na tokenach JWT (JSON Web Tokens) z automatycznym odnawianiem i mechanizmem automatycznego wylogowania przy bÅ‚Ä™dach.

### GÅ‚Ã³wne funkcje
- âœ… **Access tokeny** - krÃ³tkotrwaÅ‚e (15 minut) tokeny JWT do autoryzacji zapytaÅ„
- âœ… **Refresh tokeny** - dÅ‚ugotrwaÅ‚e (30 dni) tokeny w HTTPOnly cookies
- âœ… **Automatyczne odnawianie** - tokeny sÄ… automatycznie odnawiane 2 minuty przed wygaÅ›niÄ™ciem  
- âœ… **Automatyczne wylogowanie** - system automatycznie wylogowuje uÅ¼ytkownika przy bÅ‚Ä™dach refresh tokena
- âœ… **Bezpieczne przechowywanie** - refresh tokeny w HTTPOnly cookies, access tokeny w session storage
- âœ… **WielourzÄ…dzeniowe sesje** - zarzÄ…dzanie sesjami na rÃ³Å¼nych urzÄ…dzeniach

## ğŸ—ï¸ Architektura systemu

### Komponenty frontend

#### 1. `useJWTAuth` Composable
**Lokalizacja**: `app/composables/useJWTAuth.ts`

GÅ‚Ã³wny composable odpowiedzialny za zarzÄ…dzanie tokenami JWT:

```typescript
// Podstawowe funkcjonalnoÅ›ci
const { isAuthenticated, accessToken, refreshAccessToken } = useJWTAuth()

// Callback dla bÅ‚Ä™dÃ³w refresh tokena
jwtAuth.onRefreshError((error) => {
  console.log('Refresh token failed:', error)
  // Automatyczne wylogowanie zostanie wywoÅ‚ane
})
```

**Kluczowe funkcje**:
- Automatyczne odnawianie tokenÃ³w (2 min przed wygaÅ›niÄ™ciem)
- Callback system dla bÅ‚Ä™dÃ³w refresh tokena (`onRefreshError`)
- ZarzÄ…dzanie stanem autoryzacji
- Integracja z session storage

#### 2. `useAuth` Composable  
**Lokalizacja**: `app/composables/useAuth.ts`

GÅ‚Ã³wny interfejs autoryzacji integrujÄ…cy JWT z systemem sesji:

```typescript
const { login, logout, isAuthenticated, session } = useAuth()

// Automatyczne wylogowanie jest skonfigurowane automatycznie
// przy inicjalizacji composable
```

**Automatyczne wylogowanie**:
- Wykrywanie bÅ‚Ä™dÃ³w refresh tokena (401 responses)
- Czyszczenie tokenÃ³w z session storage
- Czyszczenie sesji uÅ¼ytkownika
- WyÅ›wietlanie powiadomienia "Session Expired"
- Przekierowanie na stronÄ™ logowania

### Komponenty backend

#### 1. Endpointy autoryzacji

**Rejestracja**: `POST /api/auth/register`
```typescript
// Tworzy nowe konto i zwraca access token + refresh token w cookie
{
  accessToken: "eyJhbGciOiJIUzI1NiIs...",
  user: { id, email, username, roles },
  expiresIn: 900 // 15 minut
}
```

**Logowanie**: `POST /api/auth/login`
```typescript
// Weryfikuje poÅ›wiadczenia i zwraca tokeny
{
  accessToken: "eyJhbGciOiJIUzI1NiIs...",
  user: { id, email, username, roles },
  expiresIn: 900 // 15 minut
}
```

**Odnawianie tokena**: `POST /api/auth/refresh`
```typescript
// Odnawia access token uÅ¼ywajÄ…c refresh tokena z cookie
{
  accessToken: "eyJhbGciOiJIUzI1NiIs...",
  expiresIn: 900 // 15 minut
}
```

#### 2. Middleware JWT
**Lokalizacja**: `server/middleware/01.jwt-auth.ts`

Automatycznie weryfikuje access tokeny dla chronionej czÄ™Å›ci API:
- Ekstraktuje tokeny z nagÅ‚Ã³wkÃ³w `Authorization: Bearer <token>`
- Weryfikuje waÅ¼noÅ›Ä‡ i integralnoÅ›Ä‡ tokenÃ³w
- Ustawia kontekst uÅ¼ytkownika dla requestÃ³w

## ğŸ”„ PrzepÅ‚yw automatycznego wylogowania

### 1. Wykrywanie bÅ‚Ä™dÃ³w refresh tokena

```mermaid
graph TD
    A[Access token wygasa] --> B[Automatyczne odnowienie]
    B --> C{Refresh token valid?}
    C -->|Tak| D[Nowy access token]
    C -->|Nie - 401| E[onRefreshError callback]
    E --> F[Automatyczne wylogowanie]
    F --> G[Czyszczenie tokenÃ³w]
    G --> H[Powiadomienie uÅ¼ytkownika]
    H --> I[Przekierowanie na login]
```

### 2. Implementacja callback systemu

**useJWTAuth** automatycznie wykrywa bÅ‚Ä™dy 401 z endpointu refresh:

```typescript
// W useJWTAuth.ts
if (response.status === 401) {
  // WywoÅ‚aj wszystkie zarejestrowane callbacki
  refreshErrorCallbacks.forEach(callback => {
    try {
      callback(new Error('Refresh token expired'))
    } catch (error) {
      console.error('Error in refresh error callback:', error)
    }
  })
}
```

**useAuth** rejestruje callback do automatycznego wylogowania:

```typescript
// W useAuth.ts - automatyczna konfiguracja
jwtAuth.onRefreshError(async (error) => {
  console.log('ğŸšª Refresh token failed, logging out automatically')
  
  // 1. WyczyÅ›Ä‡ tokeny JWT
  jwtAuth.clearTokens()
  
  // 2. WyczyÅ›Ä‡ sesjÄ™ uÅ¼ytkownika  
  await clearSession()
  
  // 3. PokaÅ¼ powiadomienie
  toast.add({
    title: 'Session Expired',
    description: 'Your session has expired. Please log in again.',
    color: 'warning'
  })
  
  // 4. Przekieruj na login (tylko jeÅ›li na chronionej stronie)
  const currentRoute = useRoute()
  if (!currentRoute.path.startsWith('/auth/') && 
      !publicRoutes.includes(currentRoute.path)) {
    await navigateTo('/auth/login')
  }
})
```

## ğŸ”’ BezpieczeÅ„stwo

### Konfiguracja cookies
```typescript
// Refresh tokeny w HTTPOnly cookies
setCookie(event, 'refresh-token', refreshToken, {
  httpOnly: true,                    // NiedostÄ™pne dla JavaScript
  secure: process.env.NODE_ENV === 'production', // HTTPS w produkcji
  sameSite: 'strict',               // Ochrona CSRF
  maxAge: 30 * 24 * 60 * 60,       // 30 dni
  path: '/'
})
```

### Walidacja tokenÃ³w
- **Access tokeny**: Weryfikowane przy kaÅ¼dym requeÅ›cie do API
- **Refresh tokeny**: Przechowywane w bazie danych z moÅ¼liwoÅ›ciÄ… uniewaÅ¼nienia
- **Automatyczne czyszczenie**: WygasÅ‚e tokeny sÄ… automatycznie usuwane

### Ochrona przed atakami
- **CSRF**: Tokeny w HTTPOnly cookies z SameSite=strict
- **XSS**: Access tokeny w session storage (nie localStorage)
- **Token theft**: KrÃ³tki czas Å¼ycia access tokenÃ³w (15 min)
- **Replay attacks**: KaÅ¼dy refresh token moÅ¼e byÄ‡ uÅ¼yty tylko raz (token rotation)

## ğŸ§ª Testing i walidacja

### Test Suite
**Lokalizacja**: `tests/` directory

Kompletny zestaw testÃ³w walidujÄ…cych funkcjonalnoÅ›Ä‡:

```bash
# Uruchom wszystkie testy
node tests/run-all-tests.cjs

# Testy jednotki sprawdzajÄ…ce:
# âœ… test-basic-auth.cjs - Podstawowa autoryzacja
# âœ… test-simple-jwt.cjs - Generowanie i walidacja JWT
# âœ… test-token-refresh.cjs - Mechanizm odnawiania tokenÃ³w  
# âœ… test-auto-logout.cjs - Automatyczne wylogowanie
# âœ… test-composable-integration.cjs - Integracja composables
# âœ… test-final-validation.cjs - Kompleksowa walidacja

# Wynik: 7/7 testÃ³w przeszÅ‚o pomyÅ›lnie (100% success rate)
```

### Testy przeglÄ…darki
**Lokalizacja**: `tests/test-auth.html`

```bash
# Uruchom serwer testowy
node tests/serve-browser-tests.cjs

# OtwÃ³rz: http://localhost:3001/test-auth.html
# DostÄ™pne testy interaktywne:
# - Rejestracja uÅ¼ytkownika
# - Logowanie i autoryzacja
# - Test automatycznego wylogowania
# - Odnawianie tokenÃ³w
```

## ğŸš€ Konfiguracja i deployment

### Zmienne Å›rodowiskowe
```bash
# JWT Configuration
JWT_SECRET=your-secret-key-here
JWT_ACCESS_TOKEN_EXPIRES_IN=15m
JWT_REFRESH_TOKEN_EXPIRES_IN=30d

# Session Configuration  
NUXT_SESSION_PASSWORD=your-session-password-here

# Environment
NODE_ENV=production
```

### Monitoring i diagnostyka

System automatycznie loguje kluczowe wydarzenia:

```typescript
// PrzykÅ‚ady logÃ³w systemu
[INFO] JWT: Access token refreshed for user 123
[WARNING] JWT: Refresh token expired for user 123  
[INFO] AUTH: Automatic logout triggered for user 123
[ERROR] JWT: Invalid refresh token detected
```

## ğŸ’¡ Najlepsze praktyki

### Dla deweloperÃ³w frontend

1. **UÅ¼ywaj useAuth** zamiast bezpoÅ›rednio useJWTAuth
2. **Nie przechowuj tokenÃ³w** w localStorage - system robi to automatycznie
3. **Sprawdzaj isAuthenticated** przed dostÄ™pem do chronionych zasobÃ³w
4. **ObsÅ‚uguj bÅ‚Ä™dy 401/403** w API calls

### Dla deweloperÃ³w backend

1. **UÅ¼ywaj middleware JWT** do ochrony endpointÃ³w
2. **Waliduj uprawnienia** na poziomie API  
3. **Loguj wydarzenia bezpieczeÅ„stwa** dla audytu
4. **Regularnie czyÅ›Ä‡** wygasÅ‚e refresh tokeny

### Dla administratorÃ³w systemu

1. **Monitoruj logi** automatycznego wylogowania
2. **Analizuj wzorce** bÅ‚Ä™dÃ³w refresh tokenÃ³w
3. **Konfiguruj alerty** dla podejrzanych aktywnoÅ›ci
4. **Regularnie aktualizuj** klucze JWT

## ğŸ”§ Troubleshooting

### CzÄ™ste problemy

**Problem**: UÅ¼ytkownicy czÄ™sto siÄ™ wylogowujÄ…
- **RozwiÄ…zanie**: SprawdÅº czas Å¼ycia tokenÃ³w i stabilnoÅ›Ä‡ sieci

**Problem**: BÅ‚Ä™dy 401 mimo waÅ¼nego tokena  
- **RozwiÄ…zanie**: Zweryfikuj synchronizacjÄ™ zegarÃ³w serwera

**Problem**: Refresh tokeny nie dziaÅ‚ajÄ…
- **RozwiÄ…zanie**: SprawdÅº konfiguracjÄ™ cookies i HTTPS

### Debugging

```typescript
// WÅ‚Ä…cz debug mode w development
if (import.meta.dev) {
  console.log('JWT Debug:', {
    isAuthenticated: isAuthenticated.value,
    tokenExpiry: tokenExpiry.value,
    timeUntilRefresh: timeUntilRefresh.value
  })
}
```

## ğŸ”® PrzyszÅ‚e ulepszenia

Planowane funkcjonalnoÅ›ci (opcjonalne):

- â³ **Multi-device session management** - zarzÄ…dzanie sesjami na wielu urzÄ…dzeniach
- â³ **Advanced token rotation** - zaawansowane strategie rotacji tokenÃ³w  
- â³ **Rate limiting** - ograniczenia prÃ³b refresh
- â³ **Session dashboard** - panel zarzÄ…dzania sesjami

---

::alert{type="info"}
System automatycznego wylogowania jest **w peÅ‚ni funkcjonalny i gotowy do produkcji**. Wszystkie testy przechodzÄ… pomyÅ›lnie i system zostaÅ‚ kompleksowo zwalidowany.
::
