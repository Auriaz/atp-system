---
title: 'Architektura systemu'
description: 'ATP System to zaawansowana aplikacja peÅ‚nostackowa zbudowana na Nuxt.js 3, Å‚Ä…czÄ…ca rendering po stronie serwera (SSR) z renderowaniem po stronie klienta.'
category: 'Development'
version: '1.0.0'
lastUpdated: '2025-05-28'
createdAt: '2025-04-18'
author: 'ATP System Team'
requiredRole: ['developer', 'admin']
icon: 'i-heroicons-cube'
status: 'published'
difficulty: 'advanced'
readingTime: 15
docType: 'specification'
navigation:
  title: 'Architektura systemu'
  icon: 'i-heroicons-cube'
  order: 1
  group: 'Techniczne'
seo:
  title: 'Architektura systemu ATP - Przewodnik techniczny'
  description: 'Kompletny przeglÄ…d architektury systemu ATP: Nuxt.js 3, Cloudflare D1, JWT authentication, session management'
  keywords: ['architektura', 'nuxt.js', 'cloudflare-d1', 'jwt', 'session-management', 'drizzle-orm']
tags: ['architecture', 'nuxt3', 'cloudflare', 'jwt', 'database']
---

# Architektura systemu

::alert{type="info"}
ATP System to zaawansowana aplikacja peÅ‚nostackowa zbudowana na Nuxt.js 3, Å‚Ä…czÄ…ca rendering po stronie serwera (SSR) z renderowaniem po stronie klienta.
::

## ğŸ—ï¸ OgÃ³lna architektura

System ATP zostaÅ‚ zbudowany w oparciu o nastÄ™pujÄ…ce technologie:

::list{type="success"}
- **Frontend**: Vue.js 3 + Nuxt.js 3.17.4+
- **Backend**: Nitro Server (zintegrowany z Nuxt.js)
- **Baza danych**: Cloudflare D1 (produkcja) / SQLite (development) z Drizzle ORM
- **Deployment**: NuxtHub (Cloudflare Pages + D1 + R2)
- **Stylowanie**: Tailwind CSS + Nuxt UI
- **ZarzÄ…dzanie zawartoÅ›ciÄ…**: Nuxt Content v3
::

### Diagram architektury

```mermaid
graph TD
    Client[Klient] --> VueComponents[Vue.js Komponenty]
    Client --> AppState[Stan aplikacji]
    VueComponents <--> AppState
    VueComponents --> Router[Vue Router/Nuxt]
    AppState --> Router
    Router --> Server[Serwer]
    Server --> ApiRoutes[API Routes]
    Server --> Middleware[Middleware]
    ApiRoutes --> Repositories[Repositories Layer]
    Middleware --> Repositories
    Repositories --> ORM[Drizzle ORM]
    ORM --> DB[(SQLite Database)]
```

## ğŸ§© GÅ‚Ã³wne komponenty systemu

::card{icon="i-heroicons-cube"}
#title
Nuxt.js Framework
#description
Nuxt.js zapewnia strukturÄ™ aplikacji, routing, middleware i integracjÄ™ serwera:

- **app/** - Zawiera gÅ‚Ã³wny kod aplikacji
- **server/** - Kod uruchamiany na serwerze
- **public/** - Statyczne zasoby
- **content/** - TreÅ›ci zarzÄ…dzane przez Nuxt Content
::

::card{icon="i-heroicons-shield-check"}
#title
System uwierzytelniania JWT z automatycznym wylogowaniem
#description
Zaawansowany system uwierzytelniania oparty na tokenach JWT z automatycznym odnawianiem i wylogowaniem:

- **JWT Access Tokeny** - krÃ³tkotrwaÅ‚e tokeny (15 min) do autoryzacji API
- **JWT Refresh Tokeny** - dÅ‚ugotrwaÅ‚e tokeny (30 dni) w HTTPOnly cookies
- **Automatyczne odnawianie** - tokeny odnawiane 2 min przed wygaÅ›niÄ™ciem
- **Automatyczne wylogowanie** - przy bÅ‚Ä™dach refresh tokena (401 responses)
- **Middleware autoryzacji** (`app/middleware/auth.ts`) - sprawdza uprawnienia uÅ¼ytkownika  
- **Middleware JWT** (`server/middleware/01.jwt-auth.ts`) - weryfikuje tokeny JWT
- **Composables** (`useJWTAuth`, `useAuth`) - zarzÄ…dzanie tokenami i sesjami
- **Bezpieczne przechowywanie** - HTTPOnly cookies + session storage
::

::card{icon="i-heroicons-user-group"}
#title
System rÃ³l i uprawnieÅ„
#description
Wielopoziomowy system kontroli dostÄ™pu:

- **Role uÅ¼ytkownikÃ³w** - ADMIN, MANAGER, COACH, EDITOR, ATHLETE, USER, OBSERVER
- **Granularne uprawnienia** - ponad 40 rÃ³Å¼nych uprawnieÅ„ podzielonych na kategorie
- **Mapowanie uprawnieÅ„ do API** - powiÄ…zanie endpointÃ³w API z wymaganymi uprawnieniami
- **Cache'owanie uprawnieÅ„** - optymalizacja wydajnoÅ›ci przez przechowywanie uprawnieÅ„ w lokalnym magazynie
::

::card{icon="i-heroicons-server"}
#title
Warstwa API
#description
Serwer Nitro obsÅ‚uguje endpointy API w katalogu api:

- **Automatyczne mapowanie URL** - pliki organizowane jako `[resource]/[action].[method].ts`
- **ObsÅ‚uga rÃ³Å¼nych metod HTTP** - GET, POST, PUT, DELETE itp.
- **Standardowy format odpowiedzi** - ujednolicona struktura odpowiedzi API
::

::card{icon="i-heroicons-database"}
#title
Warstwa bazy danych
#description
System uÅ¼ywa Cloudflare D1 w produkcji i lokalnego SQLite w development z Drizzle ORM jako warstwÄ… abstrakcji:

- **Produkcja**: Cloudflare D1 (serverless SQLite) przez NuxtHub
- **Development**: Lokalna baza SQLite
- **Schema**: Definicje tabel i relacji w schema.ts
- **Repozytoria**: Enkapsulacja logiki dostÄ™pu do danych w repositories
- **Migracje**: ObsÅ‚uga zmian schematu bazy danych przez Drizzle Kit
- **ORM**: Drizzle ORM zapewnia type-safe queries i automatyczne typy TypeScript
::

::card{icon="i-heroicons-puzzle-piece"}
#title
Komponenty UI
#description
Interfejs uÅ¼ytkownika jest zbudowany przy uÅ¼yciu Tailwind CSS i zorganizowany w moduÅ‚owe komponenty:

- **Layouts** - UkÅ‚ady stron (dashboard, public)
- **Components** - Wielokrotnego uÅ¼ytku komponenty UI
- **Pages** - PoszczegÃ³lne strony aplikacji
::

## ğŸ”„ PrzepÅ‚yw danych

::tabs
#tab{name="PrzepÅ‚yw Å¼Ä…dania HTTP" icon="i-heroicons-arrow-path"}
1. Å»Ä…danie trafia do Nuxt.js
2. Nuxt.js kieruje Å¼Ä…danie do odpowiedniej Å›cieÅ¼ki (API lub strona)
3. Middleware sprawdza uwierzytelnienie i uprawnienia
4. W przypadku API:
   - Endpoint API przetwarza Å¼Ä…danie
   - UÅ¼ywa repozytoriÃ³w do operacji na bazie danych
   - Zwraca odpowiedÅº
5. W przypadku strony:
   - Komponenty Vue sÄ… renderowane
   - Dane sÄ… pobierane za pomocÄ… composables
   - Strona jest zwracana do klienta

#tab{name="PrzepÅ‚yw uwierzytelniania JWT" icon="i-heroicons-key"}
1. UÅ¼ytkownik loguje siÄ™, przekazujÄ…c poÅ›wiadczenia (`email` + `password`)
2. Serwer weryfikuje poÅ›wiadczenia i generuje parÄ™ tokenÃ³w JWT:
   - **Access token** (15 min) - do autoryzacji API calls
   - **Refresh token** (30 dni) - w HTTPOnly cookie
3. Frontend automatycznie zarzÄ…dza tokenami:
   - Access token w session storage
   - Automatyczne odnawianie 2 min przed wygaÅ›niÄ™ciem
4. Middleware JWT weryfikuje access tokeny dla kaÅ¼dego API request
5. System uprawnieÅ„ sprawdza czy uÅ¼ytkownik ma dostÄ™p do zasobu
6. **Automatyczne wylogowanie** przy bÅ‚Ä™dach refresh tokena (401)

#tab{name="Automatyczne wylogowanie" icon="i-heroicons-arrow-right-on-rectangle"}
1. Access token wygasa po 15 minutach
2. System automatycznie prÃ³buje odnowiÄ‡ token za pomocÄ… refresh tokena
3. JeÅ›li refresh token jest nieprawidÅ‚owy (401 response):
   - Callback `onRefreshError` jest wywoÅ‚any
   - Wszystkie tokeny sÄ… czyszczone z session storage
   - Sesja uÅ¼ytkownika jest usuwana
   - Powiadomienie "Session Expired" jest wyÅ›wietlane
   - Przekierowanie na stronÄ™ logowania
4. Proces jest caÅ‚kowicie automatyczny i bezobsÅ‚ugowy
::

## ğŸ”— Komunikacja miÄ™dzy komponentami

### ZarzÄ…dzanie stanem

System wykorzystuje `useState` z Nuxt.js do zarzÄ…dzania stanem aplikacji:

```ts
// Definicja stanu
const users = useState<UserResource[]>('users', () => [])

// Aktualizacja stanu
users.value = [...newUsers]

// Odczytanie stanu w innym komponencie
const users = useState<UserResource[]>('users')
```

### Composables

ReuÅ¼ywalne funkcje (composables) enkapsulujÄ… logikÄ™ biznesowÄ… i dostÄ™p do API:

```ts
// Definicja composable
export function useUsersApi() {
  // Stan, metody, etc.
  return { /* API */ }
}

// UÅ¼ycie w komponencie
const { users, fetchUsers } = useUsersApi()
```

## âš¡ Optymalizacja wydajnoÅ›ci

::callout{type="tip"}
System ATP stosuje szereg technik optymalizacji wydajnoÅ›ci:
::

::list{type="success"}
- **Cache'owanie uprawnieÅ„ uÅ¼ytkownika** - Uprawnienia sÄ… obliczane raz i przechowywane lokalnie
- **Lazy loading komponentÃ³w** - Komponenty sÄ… Å‚adowane tylko wtedy, gdy sÄ… potrzebne
- **Selektywne pobieranie danych** - API pobiera tylko niezbÄ™dne dane
- **Strategie renderowania** - Wykorzystanie optymalnych strategii renderowania dla rÃ³Å¼nych stron
- **Cloudflare CDN** - Globalna dystrybucja treÅ›ci przez sieÄ‡ Cloudflare
- **Edge Computing** - Serwer Nitro uruchamiany na edge'u Cloudflare
- **Database Connection Pooling** - Optymalizacja poÅ‚Ä…czeÅ„ z bazÄ… D1
::

## ğŸš€ Deployment i infrastruktura

::card{icon="i-simple-icons-cloudflare"}
#title
NuxtHub + Cloudflare Stack
#description
System jest wdraÅ¼any w peÅ‚ni na infrastrukturze Cloudflare:

- **Cloudflare Pages** - Hosting dla aplikacji Nuxt.js z SSR
- **Cloudflare D1** - Serverless SQLite database w edge locations
- **Cloudflare R2** - Object storage dla plikÃ³w i media
- **Cloudflare KV** - Key-Value store dla cache i session storage
- **Cloudflare Workers** - Runtime dla Nitro server na edge
- **Automatyczne deployments** - CI/CD przez GitHub integration
::

## ğŸ” ZarzÄ…dzanie sesjami

::card{icon="i-heroicons-device-phone-mobile"}
#title
Multi-Device Session Management
#description
Zaawansowany system zarzÄ…dzania sesjami z obsÅ‚ugÄ… wielu urzÄ…dzeÅ„:

- **Device Recognition** - Automatyczne rozpoznawanie typu urzÄ…dzenia i przeglÄ…darki
- **IP Tracking** - Zapisywanie adresÃ³w IP dla celÃ³w bezpieczeÅ„stwa
- **Session Isolation** - KaÅ¼de urzÄ…dzenie ma osobnÄ… sesjÄ™
- **Remote Logout** - MoÅ¼liwoÅ›Ä‡ zdalnego wylogowania z innych urzÄ…dzeÅ„
- **Session Monitoring** - PodglÄ…d aktywnych sesji w dashboard
- **Security Alerts** - Powiadomienia o podejrzanej aktywnoÅ›ci
::

## ğŸŒ Åšrodowiska

System obsÅ‚uguje rÃ³Å¼ne Å›rodowiska z automatycznÄ… konfiguracjÄ… przez NuxtHub:

::code-group
```bash [.env.development]
NODE_ENV=development
NUXT_SESSION_PASSWORD=your-development-secret
# Lokalna baza SQLite w .data/hub/db.sqlite
```

```bash [.env.staging]
NODE_ENV=staging
# Cloudflare D1 database (staging)
# Automatic configuration via NuxtHub
```

```bash [.env.production]
NODE_ENV=production
# Cloudflare D1 database (production) 
# Cloudflare R2 storage
# Cloudflare KV cache
# Full NuxtHub stack
```
::

## ğŸ”§ RozszerzalnoÅ›Ä‡

::alert{type="success"}
Architektura systemu zostaÅ‚a zaprojektowana z myÅ›lÄ… o rozszerzalnoÅ›ci i skalowaniu w chmurze!
::

1. **ModuÅ‚owa struktura** - Åatwe dodawanie nowych funkcji przez composables i komponenty
2. **System uprawnieÅ„** - Proste dodawanie nowych uprawnieÅ„ i rÃ³l
3. **Serverless architecture** - Automatyczne skalowanie przez Cloudflare infrastructure
4. **Edge computing** - Niska latencja dziÄ™ki globalnej sieci Cloudflare
5. **Type-safe development** - TypeScript end-to-end dla lepszej maintainability
6. **Database migrations** - Bezpieczne zmiany schematu przez Drizzle Kit
7. **Multi-region deployment** - MoÅ¼liwoÅ›Ä‡ deployment w rÃ³Å¼nych regionach Cloudflare
8. **Incremental Static Regeneration** - Optymalizacja wydajnoÅ›ci dla treÅ›ci statycznych